--CREAR ID DE COMPRA DE MANERA AUTOMATICA

ALTER PROCEDURE SP_I_COMPRA_01
@SUC_ID INT,
@USER_ID INT
AS
BEGIN
	SET NOCOUNT ON
		INSERT INTO TM_COMPRA
		(SUC_ID, USER_ID,ACTIVE)
		VALUES
		(@SUC_ID, @USER_ID, 2)
		SELECT COMPRA_ID FROM TM_COMPRA WHERE COMPRA_ID = @@IDENTITY
	SET NOCOUNT OFF

END

--LISTAR DETALLES DE LA COMPRA DE LA TABLA DE TM_DETALLE_COMPRA
CREATE PROCEDURE SP_L_COMPRA_01  
@COMPRA_ID INT  
AS  
BEGIN  
 SELECT   
  TD_COMPRA_DETALLE.DET_ID,   
  TD_COMPRA_DETALLE.COMPRA_ID,   
  TD_COMPRA_DETALLE.PROD_ID,   
  TD_COMPRA_DETALLE.PROD_PCOMPRA,   
  TD_COMPRA_DETALLE.DET_CANT,   
  TD_COMPRA_DETALLE.DET_TOTAL,   
  TM_PRODUCTO.PROD_NAME,   
  TM_CATEGORIA.CAT_NAME,   
  TM_UNIDAD_DE_MEDIDA.UNID_NAME  
 FROM     TD_COMPRA_DETALLE INNER JOIN  
       TM_PRODUCTO ON TD_COMPRA_DETALLE.PROD_ID = TM_PRODUCTO.PROD_ID INNER JOIN  
       TM_CATEGORIA ON TM_PRODUCTO.CAT_ID = TM_CATEGORIA.CAT_ID INNER JOIN  
       TM_UNIDAD_DE_MEDIDA ON TM_PRODUCTO.UNID_ID = TM_UNIDAD_DE_MEDIDA.UNI_ID  
  
 WHERE   
 TD_COMPRA_DETALLE.COMPRA_ID = @COMPRA_ID  
 AND TD_COMPRA_DETALLE.ACTIVE = 1  
END
CREATE PROCEDURE SP_D_COMPRA_01
@DET_ID INT
AS
BEGIN
	UPDATE TD_COMPRA_DETALLE
	SET ACTIVE  = 0
	WHERE DET_ID = @DET_ID
END

--CALCULAR Y ACTUALIZAR LOS CAMPOS DE SUB_TOTAL, IVA Y TOTAL DE LA TABLA DE COMPRA
CREATE PROCEDURE SP_U_COMPRA_01   
@COMPRA_ID INT  
AS  
BEGIN  
SET NOCOUNT ON
	 UPDATE TM_COMPRA  
	 SET   
	  COMPRA_SUB_TOTAL = (SELECT SUM(DET_TOTAL) AS COMPRA_SUBTOTAL FROM TD_COMPRA_DETALLE WHERE COMPRA_ID = @COMPRA_ID AND ACTIVE = 1),  
	  COMPRA_IVA = COMPRA_SUB_TOTAL * 0.19 ,  
	  COMPRA_TOTAL = COMPRA_SUB_TOTAL + COMPRA_IVA  
	 WHERE   
	  COMPRA_ID = @COMPRA_ID 
  
	SELECT 
		COMPRA_SUB_TOTAL AS SUBTOTAL,
		COMPRA_IVA AS IVA,
		COMPRA_TOTAL AS TOTAL
	FROM
		TM_COMPRA
	WHERE 
		COMPRA_ID = @COMPRA_ID
		
SET NOCOUNT OFF

  
END

--LISTAR DATOS PARA LA VISTA DE LA FACTURA

CREATE PROCEDURE SP_L_COMPRA_PDF_01
@COMPRA_ID INT
AS
BEGIN
	SELECT 
		TM_COMPRA.*, 
		TM_SUCURSAL.SUC_NAME, 
		TM_EMPRESA.EMP_EMAIL, 
		TM_EMPRESA.EMP_WEBSITE, 
		TM_EMPRESA.EMP_TEL, 
		TM_EMPRESA.EMP_NAME, 
		TM_EMPRESA.EMP_RUT, 
		TM_COMPANIA.COM_NAME
	FROM  
		TM_COMPRA INNER JOIN
		TM_SUCURSAL ON TM_COMPRA.SUC_ID = TM_SUCURSAL.SUC_ID INNER JOIN
		TM_EMPRESA ON TM_SUCURSAL.EMP_ID = TM_EMPRESA.EMP_ID INNER JOIN
		TM_COMPANIA ON TM_EMPRESA.COM_ID = TM_COMPANIA.COM_ID 
	 WHERE 
		COMPRA_ID = @COMPRA_ID
 END


--ACTUALIZAR EL STOCK DE LOS PRODUCTOS 

CREATE PROCEDURE SP_U_STOCK_COMPRA_01  
@COMPRA_ID INT  
AS  
BEGIN  
 DECLARE @ID_REGISTRO INT  
 DECLARE @PROD_ID INT  
 DECLARE @CANT INT  
  
 DECLARE CUR CURSOR FOR SELECT DET_ID FROM TD_COMPRA_DETALLE WHERE COMPRA_ID = @COMPRA_ID  
 OPEN CUR   
  FETCH NEXT FROM CUR INTO @ID_REGISTRO  
  WHILE @@FETCH_STATUS=0  
   BEGIN  
    SELECT @PROD_ID = PROD_ID, @CANT = DET_CANT FROM TD_COMPRA_DETALLE WHERE DET_ID = @ID_REGISTRO  
  
    UPDATE TM_PRODUCTO  
    SET  
     PROD_STOCK = PROD_STOCK + @CANT  
    WHERE   
     PROD_ID = @PROD_ID  
    FETCH NEXT FROM CUR INTO @ID_REGISTRO  
   END  
  
  
 CLOSE CUR  
 DEALLOCATE CUR  
END

--INGRESAR DATOS DE LA COMPRA EN LA TABLA DE COMPRA CUANDO SE GUARDEN LA COMPRA

CREATE PROCEDURE SP_U_COMPRA_03   
@COMPRA_ID INT,  
@PAGO_ID INT,  
@PROV_ID INT,  
@PROV_RUT VARCHAR(150),  
@PROV_DIRC VARCHAR(150),  
@PROV_EMAIL VARCHAR(150),  
@MON_ID INT,  
@PROV_NUMBER VARCHAR(150),  
@COMPRA_COMENT VARCHAR(500)  
AS  
BEGIN  
    -- Asegurarse de que no se devuelvan filas automáticamente  
    SET NOCOUNT ON;  
  
    -- Actualizar la tabla TM_COMPRA  
    UPDATE TM_COMPRA  
    SET  
        PAGO_ID = @PAGO_ID,  
        PROV_ID = @PROV_ID,  
        PROV_RUT = @PROV_RUT,  
        PROV_DIRC = @PROV_DIRC,  
        PROV_EMAIL = @PROV_EMAIL,  
        MON_ID = @MON_ID,  
        PROV_NUMBER = @PROV_NUMBER,  
        COMPRA_COMENT = @COMPRA_COMENT,  
        CREATED_AT = GETDATE(),  
        ACTIVE = 1  
    WHERE   
        COMPRA_ID = @COMPRA_ID;  
  
    -- Habilitar la devolución de filas si es necesario  
    SET NOCOUNT OFF;  
END;  


--LISTADO DE COMPRAS EXITOSAS POR SUC_ID
CREATE PROCEDURE SP_L_COMPRA_04 
@SUC_ID INT AS  
BEGIN  
 SELECT   
    TM_COMPRA.COMPRA_ID,   
    TM_COMPRA.SUC_ID,   
    TM_COMPRA.PAGO_ID,   
    TM_COMPRA.PROV_ID,   
    TM_COMPRA.PROV_RUT,   
    TM_COMPRA.PROV_DIRC,   
    TM_COMPRA.PROV_EMAIL,   
    TM_COMPRA.MON_ID,   
    TM_COMPRA.PROV_NUMBER,   
	TM_COMPRA.COMPRA_SUB_TOTAL,   
	TM_COMPRA.COMPRA_IVA,   
	TM_COMPRA.COMPRA_TOTAL,   
	TM_COMPRA.COMPRA_COMENT,   
	TM_COMPRA.USER_ID,   
	TM_COMPRA.CREATED_AT,   
	TM_COMPRA.ACTIVE,   
	TM_SUCURSAL.SUC_NAME,   
	TM_EMPRESA.EMP_EMAIL,   
	TM_EMPRESA.EMP_WEBSITE,   
	TM_EMPRESA.EMP_TEL,   
	TM_EMPRESA.EMP_DIRC,  
	TM_EMPRESA.EMP_NAME,   
	TM_EMPRESA.EMP_RUT,   
	TM_COMPANIA.COM_NAME,   
	TM_USUARIO.USER_NUMBER,   
	TM_USUARIO.USER_DOCUMENT,   
	TM_USUARIO.USER_TYPEDOC,   
	TM_USUARIO.USER_APE,   
	TM_USUARIO.USER_ROLE_ID,   
	TM_USUARIO.USER_NAME,   
	TM_USUARIO.USER_EMAIL,   
	TM_ROL.ROLE_NAME,   
	TM_MONEDA.MON_NAME,   
	TM_PAGO.PAGO_NAME,  
	TM_PROVEEDOR.PROV_NAME  
FROM       
 TM_COMPRA INNER JOIN  
                  TM_SUCURSAL ON TM_COMPRA.SUC_ID = TM_SUCURSAL.SUC_ID INNER JOIN  
                  TM_EMPRESA ON TM_SUCURSAL.EMP_ID = TM_EMPRESA.EMP_ID INNER JOIN  
                  TM_COMPANIA ON TM_EMPRESA.COM_ID = TM_COMPANIA.COM_ID INNER JOIN  
                  TM_USUARIO ON TM_COMPRA.USER_ID = TM_USUARIO.USER_ID INNER JOIN  
      TM_ROL ON TM_USUARIO.USER_ROLE_ID = TM_ROL.ROLE_ID INNER JOIN  
                  TM_MONEDA ON TM_COMPRA.MON_ID = TM_MONEDA.MON_ID INNER JOIN  
                  TM_PAGO ON TM_COMPRA.PAGO_ID = TM_PAGO.PAGO_ID INNER JOIN  
      TM_PROVEEDOR ON TM_COMPRA.PROV_ID = TM_PROVEEDOR.PROV_ID  
  WHERE     
  TM_COMPRA.ACTIVE= 1 AND    TM_COMPRA.SUC_ID = @SUC_ID END
