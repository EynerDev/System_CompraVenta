ALTER PROCEDURE SP_I_COMPRA_01
@SUC_ID INT,
@USER_ID INT
AS
BEGIN
	SET NOCOUNT ON
		INSERT INTO TM_COMPRA
		(SUC_ID, USER_ID,ACTIVE)
		VALUES
		(@SUC_ID, @USER_ID, 2)
		SELECT COMPRA_ID FROM TM_COMPRA WHERE COMPRA_ID = @@IDENTITY
	SET NOCOUNT OFF

END
CREATE PROCEDURE SP_L_COMPRA_01  
@COMPRA_ID INT  
AS  
BEGIN  
 SELECT   
  TD_COMPRA_DETALLE.DET_ID,   
  TD_COMPRA_DETALLE.COMPRA_ID,   
  TD_COMPRA_DETALLE.PROD_ID,   
  TD_COMPRA_DETALLE.PROD_PCOMPRA,   
  TD_COMPRA_DETALLE.DET_CANT,   
  TD_COMPRA_DETALLE.DET_TOTAL,   
  TM_PRODUCTO.PROD_NAME,   
  TM_CATEGORIA.CAT_NAME,   
  TM_UNIDAD_DE_MEDIDA.UNID_NAME  
 FROM     TD_COMPRA_DETALLE INNER JOIN  
       TM_PRODUCTO ON TD_COMPRA_DETALLE.PROD_ID = TM_PRODUCTO.PROD_ID INNER JOIN  
       TM_CATEGORIA ON TM_PRODUCTO.CAT_ID = TM_CATEGORIA.CAT_ID INNER JOIN  
       TM_UNIDAD_DE_MEDIDA ON TM_PRODUCTO.UNID_ID = TM_UNIDAD_DE_MEDIDA.UNI_ID  
  
 WHERE   
 TD_COMPRA_DETALLE.COMPRA_ID = @COMPRA_ID  
 AND TD_COMPRA_DETALLE.ACTIVE = 1  
END
CREATE PROCEDURE SP_D_COMPRA_01
@DET_ID INT
AS
BEGIN
	UPDATE TD_COMPRA_DETALLE
	SET ACTIVE  = 0
	WHERE DET_ID = @DET_ID
END

CREATE PROCEDURE SP_U_COMPRA_01   
@COMPRA_ID INT  
AS  
BEGIN  
SET NOCOUNT ON
	 UPDATE TM_COMPRA  
	 SET   
	  COMPRA_SUB_TOTAL = (SELECT SUM(DET_TOTAL) AS COMPRA_SUBTOTAL FROM TD_COMPRA_DETALLE WHERE COMPRA_ID = @COMPRA_ID AND ACTIVE = 1),  
	  COMPRA_IVA = COMPRA_SUB_TOTAL * 0.19 ,  
	  COMPRA_TOTAL = COMPRA_SUB_TOTAL + COMPRA_IVA  
	 WHERE   
	  COMPRA_ID = @COMPRA_ID 
  
	SELECT 
		COMPRA_SUB_TOTAL AS SUBTOTAL,
		COMPRA_IVA AS IVA,
		COMPRA_TOTAL AS TOTAL
	FROM
		TM_COMPRA
	WHERE 
		COMPRA_ID = @COMPRA_ID
		
SET NOCOUNT OFF

  
END  

CREATE PROCEDURE SP_L_COMPRA_PDF_01
@COMPRA_ID INT
AS
BEGIN
	SELECT 
		TM_COMPRA.*, 
		TM_SUCURSAL.SUC_NAME, 
		TM_EMPRESA.EMP_EMAIL, 
		TM_EMPRESA.EMP_WEBSITE, 
		TM_EMPRESA.EMP_TEL, 
		TM_EMPRESA.EMP_NAME, 
		TM_EMPRESA.EMP_RUT, 
		TM_COMPANIA.COM_NAME
	FROM  
		TM_COMPRA INNER JOIN
		TM_SUCURSAL ON TM_COMPRA.SUC_ID = TM_SUCURSAL.SUC_ID INNER JOIN
		TM_EMPRESA ON TM_SUCURSAL.EMP_ID = TM_EMPRESA.EMP_ID INNER JOIN
		TM_COMPANIA ON TM_EMPRESA.COM_ID = TM_COMPANIA.COM_ID 
	 WHERE 
		COMPRA_ID = @COMPRA_ID
 END
